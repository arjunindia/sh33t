<!doctypehtml><html lang=en><meta charset=UTF-8><meta content="width=device-width,initial-scale=1"name=viewport><title>Sheet</title><style>*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif;font-size:16px}body,html{margin:0;padding:0;width:100%;height:100%}#sheet-grid-container{margin-top:8.5vh;width:100%;height:calc(100vh - 10vh);overflow:hidden;position:relative;display:flex;flex-direction:column}:root{--column-width:100px;--row-header-width:50px;--total-columns:50}#sheet-grid-header{display:flex;grid-gap:1px;background-color:#d3d3d3;flex-shrink:0;overflow:hidden;position:sticky;top:0;z-index:3}#column-headers-content{display:grid;grid-template-columns:repeat(var(--total-columns),var(--column-width));grid-gap:1px;width:calc(var(--total-columns) * var(--column-width) + (var(--total-columns) - 1) * 1px);position:relative;left:0}.column-header-cell,.corner-cell{background-color:#f0f0f0;border:1px solid #ccc;height:30px;line-height:20px;padding:5px;text-align:center;font-weight:700;width:var(--column-width);flex-shrink:0}.corner-cell{width:var(--row-header-width)}#sheet-grid-viewport{width:100%;flex-grow:1;overflow:auto;position:relative;display:flex}#row-headers{width:50px;flex-shrink:0;background-color:#d3d3d3;position:sticky;left:0;z-index:2}.row-header-cell{background-color:#f0f0f0;border:1px solid #ccc;height:30px;line-height:20px;padding:5px;text-align:center;font-weight:700;position:absolute;width:100%;left:0}#sheet-grid-content{position:relative;flex-grow:1}.sheet-grid-row{position:absolute;left:0;width:calc(var(--total-columns) * var(--column-width) + (var(--total-columns) - 1) * 1px);display:grid;grid-template-columns:repeat(var(--total-columns),var(--column-width));grid-gap:1px;background-color:#d3d3d3}.sheet-grid-cell{background-color:#fff;border:1px solid #ccc;padding:5px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;height:30px;line-height:20px}.sheet-grid-cell-input{width:100%;height:100%;border:none;padding:5px;font-size:16px;box-sizing:border-box;outline:0}.sheet-grid-cell:hover{background-color:#add8e6}.sheet-grid-cell.focused,.sheet-grid-cell:focus{background-color:#f08080}div[role=menubar]{display:flex;padding:5px;position:relative}#top-level-menu{display:flex;flex-direction:row}div[role=menu]{flex-direction:column;background-color:#fff;border:1px solid #000;position:absolute;z-index:10;min-width:120px;box-shadow:2px 2px 5px rgba(0,0,0,.2)}div[role=menuitem]{padding:8px 12px;cursor:pointer;white-space:nowrap;display:flex;justify-content:space-between;align-items:center}div[role=menuitem] span{margin-left:20px;color:#666;font-size:.9em}div[role=menuitem]:hover{background-color:#add8e6}.menu-closed{display:none}.menu-open{display:flex}.modal{display:none;position:fixed;z-index:100;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.4);justify-content:center;align-items:center}.modal-content{background-color:#fefefe;margin:auto;padding:20px;border:1px solid #888;width:80%;max-width:500px;box-shadow:0 4px 8px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);animation-name:animatetop;animation-duration:.4s}@-webkit-keyframes animatetop{from{top:-300px;opacity:0}to{top:0;opacity:1}}@keyframes animatetop{from{top:-300px;opacity:0}to{top:0;opacity:1}}.close-button{color:#aaa;float:right;font-size:28px;font-weight:700}.close-button:focus,.close-button:hover{color:#000;text-decoration:none;cursor:pointer}.cell-tooltip{position:absolute;background-color:#333;color:#fff;padding:5px 10px;border-radius:4px;font-size:14px;white-space:nowrap;z-index:1000;pointer-events:none;display:none;max-width:300px;word-wrap:break-word;white-space:normal}.modal-content label{display:block;margin-bottom:5px;font-weight:700}.modal-content input[type=password],.modal-content input[type=text],.modal-content select,.modal-content textarea{width:calc(100% - 10px);padding:8px;margin-bottom:10px;border:1px solid #ccc;border-radius:4px}.modal-content button{background-color:#4caf50;color:#fff;padding:10px 15px;border:none;border-radius:4px;cursor:pointer;font-size:16px}.modal-content button:hover{background-color:#45a049}</style><div aria-label="top menu"role=menubar><div id=top-level-menu role=menu><div id=file-menu-item class=menu-item role=menuitem data-submenu=file-submenu>File</div><div id=edit-menu-item class=menu-item role=menuitem data-submenu=edit-submenu>Edit</div><div id=ai-menu-item class=menu-item role=menuitem data-submenu=ai-submenu>AI</div></div><div id=file-submenu class=menu-closed role=menu aria-label="File menu"><div id=new-file-menu-item class=menu-item role=menuitem>New <span>Ctrl+N</span></div><div id=save-as-csv-menu-item class=menu-item role=menuitem>Save as CSV <span>Ctrl+S</span></div><div id=open-csv-menu-item class=menu-item role=menuitem>Open CSV <span>Ctrl+O</span></div></div><div id=edit-submenu class=menu-closed role=menu aria-label="Edit menu"><div id=undo-menu-item class=menu-item role=menuitem>Undo <span>Ctrl+Z</span></div><div id=redo-menu-item class=menu-item role=menuitem>Redo <span>Ctrl+Shift+Z</span></div><div id=cut-menu-item class=menu-item role=menuitem data-action=cut>Cut <span>Ctrl+X</span></div><div id=copy-menu-item class=menu-item role=menuitem data-action=copy>Copy <span>Ctrl+C</span></div><div id=copy-value-menu-item class=menu-item role=menuitem data-action=copy-value>Copy Value <span>Ctrl+Shift+C</span></div><div id=paste-menu-item class=menu-item role=menuitem data-action=paste>Paste <span>Ctrl+V</span></div><div id=delete-menu-item class=menu-item role=menuitem data-action=delete>Delete <span>Del</span></div></div><div id=ai-submenu class=menu-closed role=menu aria-label="AI menu"><div id=ai-settings-menu-item class=menu-item role=menuitem>Settings <span>Ctrl+Alt+S</span></div><div id=ai-ask-menu-item class=menu-item role=menuitem>Ask AI <span>Ctrl+Alt+A</span></div></div></div><div id=sheet-grid-container><div id=sheet-grid-header><div class=corner-cell></div><div id=column-headers-content></div></div><div id=sheet-grid-viewport><div id=row-headers></div><div id=sheet-grid-content></div></div></div><div id=aiSettingsModal class=modal><div class=modal-content><button aria-label="Close AI Settings"class=close-button>×</button><h2>AI Settings</h2><label for=apiBaseUrl>API Base URL:</label> <input id=apiBaseUrl placeholder="e.g., https://api.openai.com/v1"> <label for=apiKey>API Key:</label> <input id=apiKey placeholder="Your OpenAI API Key"type=password> <label for=aiModel>AI Model:</label> <input id=aiModel placeholder="e.g., gpt-3.5-turbo"> <button id=saveAiSettings>Save Settings</button></div></div><div id=askAiModal class=modal><div class=modal-content><button aria-label="Close Ask AI"class=close-button>×</button><h2>Ask AI</h2><label for=aiPrompt>Enter your prompt:</label> <textarea id=aiPrompt placeholder="Describe what you want the AI to do with the sheet data..."rows=6></textarea> <button id=submitAiPrompt>Submit</button></div></div><div id=cellTooltip class=cell-tooltip></div><script>
  const menubar=document.querySelector('div[role="menubar"]');const topMenu=document.getElementById('top-level-menu');let activeSubmenu=null;let isMenuInteraction=!1;const aiSettingsModal=document.getElementById('aiSettingsModal');const closeButton=aiSettingsModal.querySelector('.close-button');const apiBaseUrlInput=document.getElementById('apiBaseUrl');const apiKeyInput=document.getElementById('apiKey');const aiModelInput=document.getElementById('aiModel');const saveAiSettingsButton=document.getElementById('saveAiSettings');const aiSettingsMenuItem=document.getElementById('ai-settings-menu-item');const askAiModal=document.getElementById('askAiModal');const aiPromptInput=document.getElementById('aiPrompt');const submitAiPromptButton=document.getElementById('submitAiPrompt');const aiAskMenuItem=document.getElementById('ai-ask-menu-item');let aiConfig=JSON.parse(localStorage.getItem('aiConfig'))||{apiBaseUrl:'https://api.openai.com/v1',apiKey:'',aiModel:'gpt-3.5-turbo'};function saveAiSettings(){aiConfig.apiBaseUrl=apiBaseUrlInput.value;aiConfig.apiKey=apiKeyInput.value;aiConfig.aiModel=aiModelInput.value;localStorage.setItem('aiConfig',JSON.stringify(aiConfig));aiSettingsModal.style.display='none';console.log('AI Settings saved:',aiConfig)}
function trapFocus(modal,initialFocus){const focusableElements=modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');const firstElement=focusableElements[0];const lastElement=focusableElements[focusableElements.length-1];function handleKeyDown(e){if(e.key==='Tab'){if(e.shiftKey){if(document.activeElement===firstElement){e.preventDefault();lastElement.focus()}}else{if(document.activeElement===lastElement){e.preventDefault();firstElement.focus()}}}else if(e.key==='Escape'){modal.style.display='none'}}
modal.addEventListener('keydown',handleKeyDown);modal._cleanupFocusTrap=()=>{modal.removeEventListener('keydown',handleKeyDown)};if(initialFocus){requestAnimationFrame(()=>{initialFocus.focus()})}}
function openAiSettingsModal(){apiBaseUrlInput.value=aiConfig.apiBaseUrl;apiKeyInput.value=aiConfig.apiKey;aiModelInput.value=aiConfig.aiModel;aiSettingsModal.style.display='flex';trapFocus(aiSettingsModal,apiBaseUrlInput)}
function openAskAiModal(){aiPromptInput.value='';askAiModal.style.display='flex';trapFocus(askAiModal,aiPromptInput)}
function collectSheetData(){const data=[];for(let i=0;i<TOTAL_ROWS;i++){for(let j=0;j<TOTAL_COLUMNS;j++){const cellId=`${getColumnName(j)}${i + 1}`;const value=cellValues.get(cellId);const formula=cellFormulas.get(cellId);if(value||formula){const display=formula?`${formula} (${value})`:value;data.push(`${cellId}: ${display}`)}}}
return data.join(', ')}
function applyAiUpdates(updates){const changes=[];for(const[cellId,newValue]of Object.entries(updates)){const oldValue=cellValues.get(cellId);const oldFormula=cellFormulas.get(cellId);cellValues.set(cellId,newValue);cellFormulas.set(cellId,'');recordChange(cellId,oldValue,oldFormula,newValue,'');changes.push(cellId)}
reEvaluateAllCells();renderRows();console.log('Applied AI updates to cells:',changes)}
function processAiPrompt(prompt){const sheetData=collectSheetData();const fullPrompt=`Current sheet data:\n${sheetData}\n\nUser request: ${prompt}\n\nPlease provide updates in JSON format like: {"A1": "new value", "B2": "new value2"}\n Think of the spreadsheet format , cells go A1, A2... and B1, B2... etc. \nYour response should only include the JSON object. No codeblocks, tags or anything.`;submitAiPromptButton.disabled=!0;submitAiPromptButton.textContent='Processing...';fetchAiResponse(fullPrompt).then(response=>{try{const updates=JSON.parse(response);applyAiUpdates(updates);askAiModal.style.display='none';alert('Sheet updated successfully!')}catch(e){alert('Failed to parse AI response. Please try again.');console.error('JSON parse error:',e)}
console.log('AI response:',response)}).catch(error=>{alert('Error processing AI request: '+error.message);console.error('AI request error:',error)}).finally(()=>{submitAiPromptButton.disabled=!1;submitAiPromptButton.textContent='Submit'})}
aiSettingsMenuItem.addEventListener('click',(e)=>{e.stopPropagation();openAiSettingsModal();if(activeSubmenu){activeSubmenu.classList.remove('menu-open');activeSubmenu=null}
isMenuInteraction=!1});closeButton.addEventListener('click',()=>{aiSettingsModal.style.display='none';if(aiSettingsModal._cleanupFocusTrap){aiSettingsModal._cleanupFocusTrap()}});saveAiSettingsButton.addEventListener('click',saveAiSettings);window.addEventListener('click',(e)=>{if(e.target===aiSettingsModal){aiSettingsModal.style.display='none';if(aiSettingsModal._cleanupFocusTrap){aiSettingsModal._cleanupFocusTrap()}}});aiAskMenuItem.addEventListener('click',(e)=>{e.stopPropagation();openAskAiModal();if(activeSubmenu){activeSubmenu.classList.remove('menu-open');activeSubmenu=null}
isMenuInteraction=!1});const askAiCloseButton=askAiModal.querySelector('.close-button');askAiCloseButton.addEventListener('click',()=>{askAiModal.style.display='none';if(askAiModal._cleanupFocusTrap){askAiModal._cleanupFocusTrap()}});window.addEventListener('click',(e)=>{if(e.target===askAiModal){askAiModal.style.display='none';if(askAiModal._cleanupFocusTrap){askAiModal._cleanupFocusTrap()}}});submitAiPromptButton.addEventListener('click',()=>{const prompt=aiPromptInput.value.trim();if(prompt){processAiPrompt(prompt)}});topMenu.querySelectorAll('.menu-item').forEach(item=>{item.addEventListener('mousedown',(e)=>{isMenuInteraction=!0})});topMenu.querySelectorAll('.menu-item').forEach(item=>{item.addEventListener('click',(e)=>{e.stopPropagation();const submenuId=item.dataset.submenu;const submenu=document.getElementById(submenuId);if(activeSubmenu&&activeSubmenu!==submenu){activeSubmenu.classList.remove('menu-open')}
if(submenu){submenu.classList.toggle('menu-open');if(submenu.classList.contains('menu-open')){const rect=item.getBoundingClientRect();submenu.style.top=`${rect.bottom + window.scrollY}px`;submenu.style.left=`${rect.left + window.scrollX}px`;activeSubmenu=submenu}else{activeSubmenu=null;isMenuInteraction=!1}}})});document.querySelectorAll('#file-submenu .menu-item').forEach(item=>{item.addEventListener('click',(e)=>{e.stopPropagation();const menuItemId=item.id;if(menuItemId==='new-file-menu-item'){resetSheet()}else if(menuItemId==='save-as-csv-menu-item'){saveAsCSV()}else if(menuItemId==='open-csv-menu-item'){openCSV()}
if(activeSubmenu){activeSubmenu.classList.remove('menu-open');activeSubmenu=null}
isMenuInteraction=!1})});document.querySelectorAll('#edit-submenu .menu-item').forEach(item=>{item.addEventListener('click',(e)=>{e.stopPropagation();const action=item.dataset.action;const menuItemId=item.id;if(menuItemId==='undo-menu-item'){undo()}else if(menuItemId==='redo-menu-item'){redo()}else if(currentFocusedCellId){switch(action){case 'cut':cutCell(currentFocusedCellId);break;case 'copy':copyCell(currentFocusedCellId);break;case 'copy-value':copyCellValue(currentFocusedCellId);break;case 'paste':pasteCell(currentFocusedCellId);break;case 'delete':deleteCell(currentFocusedCellId);break}}
if(activeSubmenu){activeSubmenu.classList.remove('menu-open');activeSubmenu=null}
if(currentFocusedCellId&&menuItemId!=='undo-menu-item'&&menuItemId!=='redo-menu-item'){requestAnimationFrame(()=>{const cellToRefocus=document.querySelector(`.sheet-grid-cell[data-cell-id="${currentFocusedCellId}"]`);if(cellToRefocus){cellToRefocus.focus();currentFocusedCellElement=cellToRefocus}});isMenuInteraction=!1}else{isMenuInteraction=!1}})});document.addEventListener('click',(e)=>{if(activeSubmenu&&!menubar.contains(e.target)){activeSubmenu.classList.remove('menu-open');activeSubmenu=null;isMenuInteraction=!1}});const viewport=document.getElementById('sheet-grid-viewport');const content=document.getElementById('sheet-grid-content');const columnHeaderContainer=document.querySelector('#sheet-grid-header');const columnHeadersContent=document.getElementById('column-headers-content');const rowHeaderContainer=document.getElementById('row-headers');const tooltip=document.getElementById('cellTooltip');const ROW_HEIGHT=30;const COLUMN_WIDTH=100;const ROW_HEADER_WIDTH=50;const TOTAL_ROWS=1000;const TOTAL_COLUMNS=50;document.documentElement.style.setProperty('--total-columns',TOTAL_COLUMNS);const cellValues=new Map();const cellFormulas=new Map();let currentFocusedCellId=null;let currentFocusedCellElement=null;let clipboard={type:null,cellId:null,value:null,formula:null};const history=[];let historyPointer=-1;const MAX_HISTORY_SIZE=100;function recordChange(cellId,oldValue,oldFormula,newValue,newFormula){if(oldValue===newValue&&oldFormula===newFormula){return}
if(historyPointer<history.length-1){history.splice(historyPointer+1)}
history.push({cellId,oldValue,oldFormula,newValue,newFormula});historyPointer++;if(history.length>MAX_HISTORY_SIZE){history.shift();historyPointer--}
console.log('History:',history)}
function undo(){if(historyPointer<0){console.log('Nothing to undo.');return}
const lastChange=history[historyPointer];const{cellId,oldValue,oldFormula}=lastChange;cellValues.set(cellId,oldValue);cellFormulas.set(cellId,oldFormula);historyPointer--;reEvaluateAllCells();console.log(`Undo: Reverted ${cellId} to value "${oldValue}" and formula "${oldFormula}"`);const cellElement=document.querySelector(`.sheet-grid-cell[data-cell-id="${cellId}"]`);if(cellElement){cellElement.textContent=evaluateCell(cellId)}}
function redo(){if(historyPointer>=history.length-1){console.log('Nothing to redo.');return}
historyPointer++;const nextChange=history[historyPointer];const{cellId,newValue,newFormula}=nextChange;cellValues.set(cellId,newValue);cellFormulas.set(cellId,newFormula);reEvaluateAllCells();console.log(`Redo: Applied ${cellId} with value "${newValue}" and formula "${newFormula}"`);const cellElement=document.querySelector(`.sheet-grid-cell[data-cell-id="${cellId}"]`);if(cellElement){cellElement.textContent=evaluateCell(cellId)}}
function getColumnName(colIdx){let name='';let dividend=colIdx+1;let modulo;while(dividend>0){modulo=(dividend-1)%26;name=String.fromCharCode(65+modulo)+name;dividend=Math.floor((dividend-modulo)/26)}
return name}
function getColumnIdx(columnName){let idx=0;for(let i=0;i<columnName.length;i++){idx=idx*26+(columnName.charCodeAt(i)-65+1)}
return idx-1}
function parseCellReference(cellRef){const match=cellRef.match(/^([A-Z]+)(\d+)$/);if(!match)return null;const colName=match[1];const rowNum=parseInt(match[2],10);return{col:getColumnIdx(colName),row:rowNum-1}}
for(let i=0;i<TOTAL_ROWS;i++){for(let j=0;j<TOTAL_COLUMNS;j++){const cellId=`${getColumnName(j)}${i + 1}`;cellValues.set(cellId,'');cellFormulas.set(cellId,'')}}
async function fetchAiResponse(prompt){if(!navigator.onLine){return'Offline mode: AI features are not available. Please check your internet connection.'}
if(!aiConfig.apiKey||!aiConfig.apiBaseUrl||!aiConfig.aiModel){console.error('AI settings are not configured. Please set API Base URL, API Key, and AI Model in AI Settings.');return'#AI_CONFIG_ERROR!'}
try{if(aiConfig.apiBaseUrl.endsWith('/')){aiConfig.apiBaseUrl=aiConfig.apiBaseUrl.slice(0,-1)}
const response=await fetch(aiConfig.apiBaseUrl+'/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${aiConfig.apiKey}`,'x-stainless-arch':null,'x-stainless-lang':null,'x-stainless-os':null,'x-stainless-package-version':null,'x-stainless-retry-count':null,'x-stainless-runtime':null,'x-stainless-runtime-version':null,'x-stainless-timeout':null,"anthropic-dangerous-direct-browser-access":"true",},body:JSON.stringify({model:aiConfig.aiModel,messages:[{role:'user',content:prompt}],max_tokens:150})});if(!response.ok){const errorData=await response.json();console.error('AI API Error:',errorData);return `#AI_ERROR: ${errorData.error ? errorData.error.message : response.statusText}`}
const data=await response.json();return data.choices[0].message.content.trim()}catch(error){console.error('Error fetching AI response:',error);return `#AI_FETCH_ERROR: ${error.message}`}}
function evaluateCell(cellId){const formula=cellFormulas.get(cellId);if(!formula||!formula.startsWith('=')){const value=cellValues.get(cellId);return isNaN(parseFloat(value))?value:parseFloat(value)}
let expression=formula.substring(1);if(expression.startsWith('AI(')&&expression.endsWith(')')){return cellValues.get(cellId)||'#AI_PENDING...'}
const getCellValue=(ref)=>{const parsedRef=parseCellReference(ref);if(!parsedRef)return NaN;const id=`${getColumnName(parsedRef.col)}${parsedRef.row + 1}`;const value=cellValues.get(id);return isNaN(parseFloat(value))?0:parseFloat(value)};expression=expression.replace(/(SUM|AVERAGE)\(([A-Z]+\d+):([A-Z]+\d+)\)/g,(match,func,startRef,endRef)=>{const start=parseCellReference(startRef);const end=parseCellReference(endRef);if(!start||!end)return'#ERROR!';let sum=0;let count=0;for(let r=start.row;r<=end.row;r++){for(let c=start.col;c<=end.col;c++){const currentCellId=`${getColumnName(c)}${r + 1}`;const val=evaluateCell(currentCellId);if(!isNaN(val)){sum+=val;count++}}}
if(func==='SUM')return sum;if(func==='AVERAGE')return count===0?0:sum/count;return'#ERROR!'});expression=expression.replace(/[A-Z]+\d+/g,(ref)=>{return getCellValue(ref)});try{const result=new Function('return '+expression)();return result}catch(e){console.error(`Error evaluating formula for ${cellId}: ${formula}`,e);return'#ERROR!'}}
function reEvaluateAllCells(){const cellsToUpdate=[];for(const[cellId,formula]of cellFormulas.entries()){if(formula.startsWith('=')){cellsToUpdate.push(cellId)}}
for(let i=0;i<TOTAL_ROWS;i++){for(let j=0;j<TOTAL_COLUMNS;j++){const cellId=`${getColumnName(j)}${i + 1}`;if(cellsToUpdate.includes(cellId)){const evaluatedValue=evaluateCell(cellId);cellValues.set(cellId,evaluatedValue)}}}
renderRows()}
let viewportHeight=viewport.clientHeight;let viewportWidth=viewport.clientWidth-ROW_HEADER_WIDTH;let visibleRows=Math.ceil(viewportHeight/ROW_HEIGHT);let visibleColumns=Math.ceil(viewportWidth/COLUMN_WIDTH);let startRowIdx=0;let endRowIdx=startRowIdx+visibleRows;let startColIdx=0;let endColIdx=startColIdx+visibleColumns;content.style.height=`${TOTAL_ROWS * ROW_HEIGHT}px`;content.style.width=`${TOTAL_COLUMNS * COLUMN_WIDTH}px`;rowHeaderContainer.style.height=`${TOTAL_ROWS * ROW_HEIGHT}px`;content.style.height=`${TOTAL_ROWS * ROW_HEIGHT}px`;content.style.width=`${TOTAL_COLUMNS * COLUMN_WIDTH}px`;rowHeaderContainer.style.height=`${TOTAL_ROWS * ROW_HEIGHT}px`;function renderColumnHeaders(){const fragment=document.createDocumentFragment();columnHeadersContent.innerHTML='';for(let j=0;j<TOTAL_COLUMNS;j++){const colHeaderDiv=document.createElement('div');colHeaderDiv.className='column-header-cell';colHeaderDiv.textContent=getColumnName(j);fragment.appendChild(colHeaderDiv)}
columnHeadersContent.appendChild(fragment)}
function renderRows(){const contentFragment=document.createDocumentFragment();const rowHeaderFragment=document.createDocumentFragment();for(let i=startRowIdx;i<endRowIdx&&i<TOTAL_ROWS;i++){const rowHeaderDiv=document.createElement('div');rowHeaderDiv.className='row-header-cell';rowHeaderDiv.textContent=i+1;rowHeaderDiv.style.top=`${i * ROW_HEIGHT}px`;rowHeaderDiv.style.height=`${ROW_HEIGHT}px`;rowHeaderFragment.appendChild(rowHeaderDiv);const rowDiv=document.createElement('div');rowDiv.className='sheet-grid-row';rowDiv.style.height=`${ROW_HEIGHT}px`;rowDiv.style.top=`${i * ROW_HEIGHT}px`;for(let j=startColIdx;j<endColIdx&&j<TOTAL_COLUMNS;j++){const cellId=`${getColumnName(j)}${i + 1}`;const cellDiv=document.createElement('div');cellDiv.className='sheet-grid-cell';cellDiv.textContent=cellValues.get(cellId);cellDiv.style.gridColumnStart=j+1;cellDiv.setAttribute('tabindex','0');cellDiv.setAttribute('data-cell-id',cellId);if(cellId===currentFocusedCellId){cellDiv.classList.add('focused');currentFocusedCellElement=cellDiv}
cellDiv.addEventListener('dblclick',()=>editCell(cellDiv));cellDiv.addEventListener('focus',()=>{if(currentFocusedCellElement&&currentFocusedCellElement!==cellDiv){currentFocusedCellElement.classList.remove('focused')}
currentFocusedCellId=cellId;currentFocusedCellElement=cellDiv;currentFocusedCellElement.classList.add('focused');const content=cellDiv.textContent.trim();if(content.length>12&&content!==''){const rect=cellDiv.getBoundingClientRect();tooltip.textContent=content;tooltip.style.left=`${rect.left + window.scrollX}px`;tooltip.style.top=`${rect.bottom + window.scrollY + 5}px`;tooltip.style.display='block'}});cellDiv.addEventListener('blur',()=>{if(isMenuInteraction){return}
if(currentFocusedCellElement===cellDiv){currentFocusedCellElement.classList.remove('focused');currentFocusedCellId=null;currentFocusedCellElement=null;tooltip.style.display='none'}});rowDiv.appendChild(cellDiv)}
contentFragment.appendChild(rowDiv)}
content.innerHTML='';content.appendChild(contentFragment);rowHeaderContainer.innerHTML='';rowHeaderContainer.appendChild(rowHeaderFragment)}
function handleScroll(){const scrollTop=viewport.scrollTop;const scrollLeft=viewport.scrollLeft;const newStartRowIdx=Math.floor(scrollTop/ROW_HEIGHT);const newStartColIdx=Math.floor(scrollLeft/COLUMN_WIDTH);let needsRender=!1;if(newStartRowIdx!==startRowIdx){startRowIdx=newStartRowIdx;endRowIdx=Math.min(startRowIdx+visibleRows,TOTAL_ROWS);needsRender=!0}
if(newStartColIdx!==startColIdx){startColIdx=newStartColIdx;endColIdx=Math.min(startColIdx+visibleColumns,TOTAL_COLUMNS);needsRender=!0}
if(needsRender){renderColumnHeaders();renderRows()}
columnHeadersContent.style.transform=`translateX(-${scrollLeft}px)`}
function editCell(cellDiv){const cellId=cellDiv.dataset.cellId;const currentValue=cellValues.get(cellId);const input=document.createElement('input');input.type='text';input.className='sheet-grid-cell-input';input.value=cellFormulas.get(cellId)||currentValue;cellDiv.innerHTML='';cellDiv.appendChild(input);input.focus();const saveChanges=()=>{saveCell(input,cellDiv,cellId)};input.addEventListener('blur',saveChanges);input.addEventListener('keydown',(e)=>{if(e.key==='Enter'){saveChanges()}})}
function saveCell(inputElement,cellDiv,cellId){const oldValue=cellValues.get(cellId);const oldFormula=cellFormulas.get(cellId);const newValue=inputElement.value;let newFormula='';let newDisplayValue='';if(newValue.startsWith('=')){newFormula=newValue;cellFormulas.set(cellId,newFormula);if(newFormula.startsWith('=AI(')&&newFormula.endsWith(')')){const prompt=newFormula.substring(4,newFormula.length-1);cellValues.set(cellId,'#AI_LOADING...');cellDiv.textContent='#AI_LOADING...';reEvaluateAllCells();fetchAiResponse(prompt).then(response=>{const finalValue=response;cellValues.set(cellId,finalValue);recordChange(cellId,oldValue,oldFormula,finalValue,newFormula);reEvaluateAllCells();const cellElement=document.querySelector(`.sheet-grid-cell[data-cell-id="${cellId}"]`);if(cellElement){cellElement.textContent=finalValue}}).catch(error=>{console.error('AI formula execution failed:',error);const errorValue=`#AI_ERROR: ${error.message}`;cellValues.set(cellId,errorValue);recordChange(cellId,oldValue,oldFormula,errorValue,newFormula);reEvaluateAllCells();const cellElement=document.querySelector(`.sheet-grid-cell[data-cell-id="${cellId}"]`);if(cellElement){cellElement.textContent=errorValue}});newDisplayValue='#AI_LOADING...'}else{newDisplayValue=evaluateCell(cellId);cellValues.set(cellId,newDisplayValue);recordChange(cellId,oldValue,oldFormula,newDisplayValue,newFormula);cellDiv.innerHTML='';cellDiv.textContent=newDisplayValue;reEvaluateAllCells()}}else{cellFormulas.set(cellId,'');newDisplayValue=newValue;cellValues.set(cellId,newDisplayValue);recordChange(cellId,oldValue,oldFormula,newDisplayValue,newFormula);cellDiv.innerHTML='';cellDiv.textContent=newDisplayValue;reEvaluateAllCells()}
requestAnimationFrame(()=>{const cellToRefocus=document.querySelector(`.sheet-grid-cell[data-cell-id="${cellId}"]`);if(cellToRefocus){cellToRefocus.focus();currentFocusedCellElement=cellToRefocus}})}
document.addEventListener('keydown',(e)=>{if(e.target.tagName==='INPUT'&&e.target.closest('#aiSettingsModal')){return}
if(e.target.tagName==='TEXTAREA'&&e.target.closest('#askAiModal')){return}
if(e.metaKey||e.ctrlKey){switch(e.key){case 'z':e.preventDefault();if(e.shiftKey){redo()}else{undo()}
return;case 'y':e.preventDefault();redo();return;case 's':e.preventDefault();if(e.altKey){openAiSettingsModal()}else{saveAsCSV()}
return;case 'a':if(e.altKey){e.preventDefault();openAskAiModal();return}
break;case 'o':e.preventDefault();openCSV();return;case 'n':e.preventDefault();resetSheet();return}}
const isEditing=e.target.classList.contains('sheet-grid-cell-input');let cellIdToNavigateFrom=currentFocusedCellId;if(!cellIdToNavigateFrom)return;if(isEditing){if(e.key==='Enter'){e.preventDefault();e.target.blur()}
return}
const focusedCell=document.querySelector(`.sheet-grid-cell[data-cell-id="${cellIdToNavigateFrom}"]`);if(!focusedCell)return;let{col,row}=parseCellReference(cellIdToNavigateFrom);let newCol=col;let newRow=row;let needsScroll=!1;switch(e.key){case 'ArrowUp':newRow=Math.max(0,row-1);needsScroll=!0;break;case 'ArrowDown':newRow=Math.min(TOTAL_ROWS-1,row+1);needsScroll=!0;break;case 'ArrowLeft':newCol=Math.max(0,col-1);needsScroll=!0;break;case 'ArrowRight':newCol=Math.min(TOTAL_COLUMNS-1,col+1);needsScroll=!0;break;case 'Enter':e.preventDefault();editCell(focusedCell);return;case 'Delete':case 'Backspace':e.preventDefault();if(cellIdToNavigateFrom){cellValues.set(cellIdToNavigateFrom,'');cellFormulas.set(cellIdToNavigateFrom,'');reEvaluateAllCells()}
return;case 'c':if((e.metaKey||e.ctrlKey)&&e.shiftKey){e.preventDefault();copyCellValue(cellIdToNavigateFrom)}else if(e.metaKey||e.ctrlKey){e.preventDefault();copyCell(cellIdToNavigateFrom)}
return;case 'x':if(e.metaKey||e.ctrlKey){e.preventDefault();cutCell(cellIdToNavigateFrom)}
return;case 'v':if(e.metaKey||e.ctrlKey){e.preventDefault();pasteCell(cellIdToNavigateFrom)}
return}
if(newCol!==col||newRow!==row){const newCellId=`${getColumnName(newCol)}${newRow + 1}`;if(newRow<startRowIdx){viewport.scrollTop=newRow*ROW_HEIGHT}else if(newRow>=endRowIdx){viewport.scrollTop=(newRow-visibleRows+1)*ROW_HEIGHT}
if(newCol<startColIdx){viewport.scrollLeft=newCol*COLUMN_WIDTH}else if(newCol>=endColIdx){viewport.scrollLeft=(newCol-visibleColumns+1)*COLUMN_WIDTH}
requestAnimationFrame(()=>{const newlyRenderedCell=document.querySelector(`.sheet-grid-cell[data-cell-id="${newCellId}"]`);if(newlyRenderedCell){newlyRenderedCell.focus()}})}});function copyCell(cellId){clipboard.type='copy';clipboard.cellId=cellId;clipboard.value=cellValues.get(cellId);clipboard.formula=cellFormulas.get(cellId);console.log(`Copied ${cellId}: ${clipboard.formula || clipboard.value}`)}
function copyCellValue(cellId){clipboard.type='copy';clipboard.cellId=cellId;clipboard.value=cellValues.get(cellId);clipboard.formula='';console.log(`Copied value of ${cellId}: ${clipboard.value}`)}
function cutCell(cellId){const oldValue=cellValues.get(cellId);const oldFormula=cellFormulas.get(cellId);clipboard.type='cut';clipboard.cellId=cellId;clipboard.value=oldValue;clipboard.formula=oldFormula;cellValues.set(cellId,'');cellFormulas.set(cellId,'');recordChange(cellId,oldValue,oldFormula,'','');reEvaluateAllCells();console.log(`Cut ${cellId}: ${clipboard.formula || clipboard.value}`)}
function pasteCell(targetCellId){if(!clipboard.type||!clipboard.cellId){console.log('Clipboard is empty.');return}
const oldValue=cellValues.get(targetCellId);const oldFormula=cellFormulas.get(targetCellId);cellValues.set(targetCellId,clipboard.value);cellFormulas.set(targetCellId,clipboard.formula);recordChange(targetCellId,oldValue,oldFormula,clipboard.value,clipboard.formula);if(clipboard.type==='cut'){clipboard.type=null;clipboard.cellId=null;clipboard.value=null;clipboard.formula=null}
reEvaluateAllCells();console.log(`Pasted to ${targetCellId}`)}
function deleteCell(cellId){const oldValue=cellValues.get(cellId);const oldFormula=cellFormulas.get(cellId);cellValues.set(cellId,'');cellFormulas.set(cellId,'');recordChange(cellId,oldValue,oldFormula,'','');reEvaluateAllCells();console.log(`Deleted content of ${cellId}`)}
function saveAsCSV(){let csvContent="";let maxRowWithContent=-1;let maxColWithContent=-1;for(let i=0;i<TOTAL_ROWS;i++){for(let j=0;j<TOTAL_COLUMNS;j++){const cellId=`${getColumnName(j)}${i + 1}`;const cellContent=cellFormulas.get(cellId)||cellValues.get(cellId);if(cellContent!==''&&cellContent!==null&&cellContent!==undefined){if(i>maxRowWithContent)maxRowWithContent=i;if(j>maxColWithContent)maxColWithContent=j}}}
if(maxRowWithContent===-1){console.log('No content to save as CSV.')}else{for(let i=0;i<=maxRowWithContent;i++){const rowData=[];for(let j=0;j<=maxColWithContent;j++){const cellId=`${getColumnName(j)}${i + 1}`;let cellContent=cellValues.get(cellId);if(cellContent===null||cellContent===undefined){cellContent=''}else if(typeof cellContent!=='string'){cellContent=String(cellContent)}
if(cellContent.includes(',')||cellContent.includes('"')||cellContent.includes('\n')){cellContent=`"${cellContent.replace(/"/g, '""')}"`}
rowData.push(cellContent)}
csvContent+=rowData.join(',')+'\n'}}
const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'});const link=document.createElement('a');if(link.download!==undefined){const url=URL.createObjectURL(blob);link.setAttribute('href',url);link.setAttribute('download','spreadsheet.csv');link.style.visibility='hidden';document.body.appendChild(link);link.click();document.body.removeChild(link)}else{alert('Your browser does not support downloading files directly. Please copy the content manually.')}
console.log('Saved as CSV')}
function openCSV(){const input=document.createElement('input');input.type='file';input.accept='.csv';input.style.position='absolute';input.style.left='-9999px';document.body.appendChild(input);input.addEventListener('change',(event)=>{const file=event.target.files[0];if(file){const reader=new FileReader();reader.onload=(e)=>{const csvContent=e.target.result;parseCSV(csvContent);document.body.removeChild(input)};reader.readAsText(file)}else{document.body.removeChild(input)}});input.click();console.log('Opening CSV file dialog...')}
function parseCSV(csvContent){cellValues.clear();cellFormulas.clear();history.length=0;historyPointer=-1;const lines=csvContent.split(/\r?\n/).filter(line=>line.trim()!=='');if(lines.length===0){console.warn('CSV file is empty.');reEvaluateAllCells();return}
const headerLine=lines.shift();const headers=parseCSVLine(headerLine);let maxCols=headers.length;for(const line of lines){const row=parseCSVLine(line);if(row.length>maxCols){maxCols=row.length}}
for(let i=0;i<lines.length;i++){const rowData=parseCSVLine(lines[i]);for(let j=0;j<maxCols;j++){const cellId=`${getColumnName(j)}${i + 1}`;let content=rowData[j]!==undefined?rowData[j]:'';if(typeof content==='string'&&content.startsWith('=')){cellFormulas.set(cellId,content);cellValues.set(cellId,evaluateCell(cellId))}else{cellFormulas.set(cellId,'');cellValues.set(cellId,content)}}}
for(let i=lines.length;i<TOTAL_ROWS;i++){for(let j=0;j<TOTAL_COLUMNS;j++){const cellId=`${getColumnName(j)}${i + 1}`;cellValues.set(cellId,'');cellFormulas.set(cellId,'')}}
for(let i=0;i<TOTAL_ROWS;i++){for(let j=maxCols;j<TOTAL_COLUMNS;j++){const cellId=`${getColumnName(j)}${i + 1}`;cellValues.set(cellId,'');cellFormulas.set(cellId,'')}}
reEvaluateAllCells();renderRows();console.log('CSV file loaded successfully.')}
function parseCSVLine(line){const result=[];let inQuote=!1;let currentField='';for(let i=0;i<line.length;i++){const char=line[i];if(char==='"'){if(inQuote&&i+1<line.length&&line[i+1]==='"'){currentField+='"';i++}else{inQuote=!inQuote}}else if(char===','&&!inQuote){result.push(currentField);currentField=''}else{currentField+=char}}
result.push(currentField);return result}
function resetSheet(){cellValues.clear();cellFormulas.clear();for(let i=0;i<TOTAL_ROWS;i++){for(let j=0;j<TOTAL_COLUMNS;j++){const cellId=`${getColumnName(j)}${i + 1}`;cellValues.set(cellId,'');cellFormulas.set(cellId,'')}}
history.length=0;historyPointer=-1;reEvaluateAllCells();renderRows();console.log('Sheet reset successfully.')}
viewport.addEventListener('scroll',handleScroll);renderColumnHeaders();renderRows();window.addEventListener('resize',()=>{viewportHeight=viewport.clientHeight;viewportWidth=viewport.clientWidth-ROW_HEADER_WIDTH;visibleRows=Math.ceil(viewportHeight/ROW_HEIGHT);visibleColumns=Math.ceil(viewportWidth/COLUMN_WIDTH);endRowIdx=Math.min(startRowIdx+visibleRows,TOTAL_ROWS);endColIdx=Math.min(startColIdx+visibleColumns,TOTAL_COLUMNS);renderColumnHeaders();renderRows()})
</script>